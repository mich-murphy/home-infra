---
services:
  # NOTE: create initial user with `docker exec -it ptero-panel php artisan p:user:make`
  # wings can be setup on host via docker-compose: https://github.com/pterodactyl/wings/blob/develop/docker-compose.example.yml
  panel:
    image: ghcr.io/pterodactyl/panel:latest
    container_name: ptero-panel
    networks:
      - proxy
      - ptero
    environment:
      - APP_URL=http://pterodactyl.local.elmurphy.com
      - APP_TIMEZONE=${TZ}
      - APP_SERVICE_AUTHOR=${APP_SERVICE_AUTHOR}
      - TRUSTED_PROXIES="*"
      - MAIL_FROM=noreply@example.com
      - MAIL_DRIVER=smtp
      - MAIL_HOST=mail
      - MAIL_PORT=1025
      - MAIL_USERNAME=""
      - MAIL_PASSWORD=""
      - MAIL_ENCRYPTION=true
      - DB_PASSWORD=${DB_PASSWORD}
      - APP_ENV=production
      - APP_ENVIRONMENT_ONLY=false
      - CACHE_DRIVER=redis
      - SESSION_DRIVER=redis
      - QUEUE_DRIVER=redis
      - REDIS_HOST=cache
      - DB_HOST=database
      - DB_PORT=3306
    volumes:
      - ptero-data:/app/var/
      - ptero-nginx:/etc/nginx/http.d/
      - ptero-logs:/app/storage/logs
    links:
      - database
      - cache
    labels:
      - traefik.enable=true
      - traefik.http.routers.pterodactyl.rule=Host(`pterodactyl.local.elmurphy.com`)
      - traefik.http.routers.pterodactyl.tls=true
      - traefik.http.services.pterodactyl.loadbalancer.server.port=80
    restart: unless-stopped

  database:
    image: mariadb:10.5
    container_name: ptero-db
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - ptero
    environment:
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=panel
      - MYSQL_USER=pterodactyl
    volumes:
      - ptero-db:/var/lib/mysql
    restart: unless-stopped

  cache:
    image: redis:alpine
    container_name: ptero-cache
    networks:
      - ptero
    restart: unless-stopped

volumes:
  ptero-data:
    name: ptero-data
  ptero-nginx:
    name: ptero-nginx
  ptero-logs:
    name: ptero-logs
  ptero-db:
    name: ptero-db

networks:
  proxy:
    external: true
  ptero:
    name: ptero
    external: true
