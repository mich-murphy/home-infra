---
services:
  jellyfin:
    image: jellyfin/jellyfin
    container_name: jellyfin
    user: 1000:1000
    networks:
      - proxy
    devices:
      - /dev/dri:/dev/dri
    group_add:
      - 992 # render group 
    environment:
      - JELLYFIN_PublishedServerUrl=https://jellyfin.local.elmurphy.com
    volumes:
      - jellyfin-data:/config
      - jellyfin-cache:/cache
      - /mnt/data/media:/data/media:rw
      - /dev/shm:/transcode # ram transcode
    labels:
      - traefik.enable=true
      - traefik.http.routers.jellyfin.rule=Host(`jellyfin.local.elmurphy.com`)
      - traefik.http.routers.jellyfin.tls=true
      - traefik.http.services.jellyfin.loadbalancer.server.port=8096
      ## Middleware
      - 'traefik.http.routers.jellyfin.middlewares=jellyfin-mw'
      #### The customResponseHeaders option lists the Header names and values to apply to the response.
      - 'traefik.http.middlewares.jellyfin-mw.headers.customResponseHeaders.X-Robots-Tag=noindex,nofollow,nosnippet,noarchive,notranslate,noimageindex'
      #### The stsSeconds is the max-age of the Strict-Transport-Security header. If set to 0, would NOT include the header.
      - 'traefik.http.middlewares.jellyfin-mw.headers.STSSeconds=315360000'
      #### The stsIncludeSubdomains is set to true, the includeSubDomains directive will be
      #### appended to the Strict-Transport-Security header.
      - 'traefik.http.middlewares.jellyfin-mw.headers.STSIncludeSubdomains=true'
      #### Set stsPreload to true to have the preload flag appended to the Strict-Transport-Security header.
      - 'traefik.http.middlewares.jellyfin-mw.headers.STSPreload=true'
      #### Set forceSTSHeader to true, to add the STS header even when the connection is HTTP.
      - 'traefik.http.middlewares.jellyfin-mw.headers.forceSTSHeader=true'
      #### Set contentTypeNosniff to true to add the X-Content-Type-Options header with the value nosniff.
      - 'traefik.http.middlewares.jellyfin-mw.headers.contentTypeNosniff=true'
      #### Set browserXssFilter to true to add the X-XSS-Protection header with the value 1; mode=block.
      - 'traefik.http.middlewares.jellyfin-mw.headers.customresponseheaders.X-XSS-PROTECTION=1'
      - traefik.http.services.jellyfin.loadBalancer.passHostHeader=true
    restart: unless-stopped

  jellyseerr:
    image: ghcr.io/fallenbagel/jellyseerr:latest
    container_name: jellyseerr
    networks:
      - proxy
    environment:
      - TZ=${TZ}
      - LOG_LEVEL=info
    volumes:
      - jellyseerr-data:/app/config
    labels:
      - traefik.enable=true
      - traefik.http.routers.jellyseerr.rule=Host(`jellyseerr.local.elmurphy.com`)
      - traefik.http.routers.jellyseerr.tls=true
      - traefik.http.services.jellyseerr.loadbalancer.server.port=5055
    restart: unless-stopped

volumes:
  jellyfin-data:
    name: jellyfin-data
  jellyfin-cache:
    name: jellyfin-cache
  jellyseerr-data:
    name: jellyseerr-data

networks:
  proxy:
    external: true
