---
services:
  # NOTE: visit https://<server-ip>:32400/web to setup new server
  plex:
    image: plexinc/pms-docker:1.43.0.10467-2b1ba6e69@sha256:d38767ec3b948e860bcf1abfe16512bd638e6ac01230f5b65b64e2ef09052267
    container_name: plex
    security_opt:
      - no-new-privileges:true
    networks:
      - proxy
    devices:
      - /dev/dri:/dev/dri
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ}
      - PLEX_CLAIM=${PLEX_CLAIM}
    volumes:
      - plex-data:/config
      - /mnt/data/media:/data/media:rw
      - /mnt/music:/data/music:rw
      - /dev/shm:/transcode # ram transcode
    labels:
      - traefik.enable=true
      - traefik.http.routers.plex.rule=Host(`plex.local.elmurphy.com`)
      - traefik.http.routers.plex.tls=true
      - traefik.http.services.plex.loadbalancer.server.port=32400
    restart: unless-stopped

  tautulli:
    image: ghcr.io/linuxserver/tautulli:v2.16.0-ls216@sha256:31bce3c8457e74392c8c451eee315a759f8b96ec7cff6060596152d7e893b776
    container_name: tautulli
    security_opt:
      - no-new-privileges:true
    networks:
      - proxy
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ}
    volumes:
      - tautulli-data:/config
    labels:
      - traefik.enable=true
      - traefik.http.routers.tautulli.rule=Host(`tautulli.local.elmurphy.com`)
      - traefik.http.routers.tautulli.tls=true
      - traefik.http.services.tautulli.loadbalancer.server.port=8181
    restart: unless-stopped

  overseerr:
    image: ghcr.io/seerr-team/seerr:latest
    container_name: seerr
    security_opt:
      - no-new-privileges:true
    user: 1000:1000
    networks:
      - proxy
    environment:
      - LOG_LEVEL=debug
      - TZ=${TZ}
    volumes:
      - overseerr-data:/config
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:5055/api/v1/status || exit 1
      start_period: 20s
      timeout: 3s
      interval: 15s
      retries: 3
    labels:
      - traefik.enable=true
      - traefik.http.routers.overseerr.rule=Host(`overseerr.local.elmurphy.com`)
      - traefik.http.routers.overseerr.tls=true
      - traefik.http.services.overseerr.loadbalancer.server.port=5055
    restart: unless-stopped

  maintainerr:
    image: ghcr.io/jorenn92/maintainerr:2.19.0@sha256:bee84707edaf589cda3d18b6813cbfe3a137b52786210c3a28190e10910c1240
    container_name: maintainerr
    security_opt:
      - no-new-privileges:true
    user: 1000:1000
    networks:
      - proxy
    environment:
      - TZ=${TZ}
    volumes:
      - maintainerr-data:/opt/data
    labels:
      - traefik.enable=true
      - traefik.http.routers.maintainerr.rule=Host(`maintainerr.local.elmurphy.com`)
      - traefik.http.routers.maintainerr.tls=true
      - traefik.http.services.maintainerr.loadbalancer.server.port=6246
    restart: unless-stopped

  # Manually setup initial config
  # Reference: https://kometa.wiki/en/latest/kometa/install/walkthroughs/docker/#setting-up-the-initial-config-file
  kometa:
    image: kometateam/kometa:v2.3.0
    container_name: kometa
    security_opt:
      - no-new-privileges:true
    user: 1000:1000
    networks:
      - proxy
    volumes:
      - kometa-data:/config
    restart: unless-stopped

volumes:
  plex-data:
    name: plex-data
  tautulli-data:
    name: tautulli-data
  overseerr-data:
    name: overseerr-data
  maintainerr-data:
    name: maintainerr-data
  kometa-data:
    name: kometa-data

networks:
  proxy:
    external: true
