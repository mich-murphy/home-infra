---
- name: set clone directory
  ansible.builtin.set_fact:
    clone_dir: /tmp/home-infra
    srv_dir: "/srv/portainer"

- name: clone docker repo
  ansible.builtin.git:
    repo: "https://github.com/mich-murphy/home-infra.git"
    dest: "{{ clone_dir }}"
    depth: 1

- name: confirm clone directory exists
  ansible.builtin.stat:
    path: "{{ clone_dir }}"
  register: repo

- name: delete existing docker directory
  ansible.builtin.file:
    path: "{{ srv_dir }}"
    state: absent
  when: repo.stat.exists

- name: copy portainer compose file
  ansible.builtin.copy:
    remote_src: true
    src: "{{ clone_dir }}/docker/portainer/compose.yml"
    dest: "{{ srv_dir }}/"
    owner: "{{ username }}"
    mode: "0775"
  when: repo.stat.exists

- name: delete clone directory
  ansible.builtin.file:
    path: "{{ clone_dir }}"
    state: absent
  when: repo.stat.exists

- name: start portainer compose file
  ansible.builtin.shell:
    cmd: docker compose up -d --force-recreate
    chdir: "{{ srv_dir }}"
